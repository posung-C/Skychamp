{# templates/index.html #}
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>學生成績總覽</title>
  <!-- 載入前端打包 ZIP 與觸發下載所需的 JSZip、FileSaver.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      margin-bottom: 10px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 600px;
    }
    th, td {
      border: 1px solid #999;
      padding: 8px 12px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    #downloadAllBtn {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      background-color: #4CAF50;
      color: white;
      border-radius: 4px;
    }
    #downloadAllBtn:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    .link-cell a {
      color: #0066cc;
      text-decoration: none;
    }
    .link-cell a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>學生成績總覽</h1>

  {# 一鍵下載所有 PDF 的按鈕 #}
  <button id="downloadAllBtn">一鍵下載所有 PDF</button>

  {# 顯示學生學號與姓名，以及單獨下載該生 PDF 的連結 #}
  <table>
    <thead>
      <tr>
        <th>學號</th>
        <th>姓名</th>
        <th>下載 PDF</th>
      </tr>
    </thead>
    <tbody>
      {# 假設 generate_reports.py 傳入的 student_list 是如下形式：
         student_list = [
           {'id': '108001', 'name': '張小明'},
           {'id': '108002', 'name': '陳美麗'},
           ...
         ]
      #}
      {% for student in student_list %}
      <tr>
        <td>{{ student.id }}</td>
        <td>{{ student.name }}</td>
        <td class="link-cell">
          <a href="students/{{ student.id }}.pdf" target="_blank">下載</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    // --------------------------------------------------------------------
    // 前瞻性思考：若將來學生人數、檔案量持續增長，打包 ZIP 可避免一次性多個瀏覽器彈跳視窗問題，
    // 同時也能確保檔案命名一致、下載體驗更流暢。若未來有後端需求，也可改為伺服器端打包 ZIP。
    // --------------------------------------------------------------------

    // 1. 將 Jinja2 模板中的 student_list 轉成前端的陣列 (只需學號即可，因為下載時只用到學號)
    const students = [
      {% for student in student_list %}
        { id: '{{ student.id }}' }{% if not loop.last %},{% endif %}
      {% endfor %}
    ];

    // 2. 一鍵下載按鈕的邏輯：依序抓取每個 PDF，打包到 ZIP，再一次性下載
    const downloadBtn = document.getElementById("downloadAllBtn");
    downloadBtn.addEventListener("click", async () => {
      downloadBtn.disabled = true;
      downloadBtn.textContent = "下載中……請稍候";

      const zip = new JSZip();
      const basePath = "students/";  // PDF 檔案相對於 index.html 的路徑

      // 並行抓取所有學生 PDF
      const fetchPromises = students.map(stu => {
        const pdfURL = `${basePath}${stu.id}.pdf`;
        return fetch(pdfURL)
          .then(response => {
            if (!response.ok) {
              console.warn(`${stu.id}.pdf 下載失敗，狀態碼：${response.status}`);
              return null;
            }
            return response.blob().then(blob => ({ id: stu.id, blob }));
          })
          .catch(err => {
            console.error(`${stu.id}.pdf 下載錯誤：`, err);
            return null;
          });
      });

      const results = await Promise.all(fetchPromises);

      // 把成功拿到的 blob 加進 ZIP，檔名格式為「學號.pdf」
      results.forEach(item => {
        if (item && item.blob) {
          zip.file(`${item.id}.pdf`, item.blob);
        }
      });

      // 產生 ZIP 並觸發下載
      try {
        const zipBlob = await zip.generateAsync({ type: "blob" });
        saveAs(zipBlob, "所有學生報告.zip");
      } catch (err) {
        console.error("ZIP 生成失敗：", err);
        alert("產生 ZIP 檔時發生錯誤，請稍後再試。");
      }

      // 恢復按鈕狀態
      downloadBtn.disabled = false;
      downloadBtn.textContent = "一鍵下載所有 PDF";
    });
  </script>
</body>
</html>
